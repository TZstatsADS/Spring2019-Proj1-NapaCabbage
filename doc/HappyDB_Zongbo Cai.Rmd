---
html_document:
  code_folding: hide
output:
  html_document:
    df_print: paged
title: "Statistical Analysis for Marriage in HappyDB"
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r echo=FALSE, results='hide',message=FALSE}
##Import libraries and read needed data.
library(rvest)
library(sentimentr)
library(gridExtra)
library(ggplot2)
library(tm)
library(wordcloud2)
library(RColorBrewer)
library(dplyr)
library(tidytext)
library(scales)
library(ngram)
library(syuzhet)
library(qdap)
library(widyr)
library(igraph)
library(ggraph)
library(tidyr)

happy_moment_data <- read.csv("/Users/zongbocai/Documents/GitHub/Spring2019-Proj1-NapaCabbage/output/processed_moments.csv", as.is = TRUE)
demographic_data <- read.csv("/Users/zongbocai/Documents/GitHub/Spring2019-Proj1-NapaCabbage/data/demographic.csv")
combined_data <- happy_moment_data %>% inner_join(demographic_data, by = "wid")
entertainment_topic <- read.csv("/Users/zongbocai/Documents/GitHub/Spring2019-Proj1-NapaCabbage/data/topic_dict/entertainment-dict.csv", header = FALSE)
exercise_topic <- read.csv("/Users/zongbocai/Documents/GitHub/Spring2019-Proj1-NapaCabbage/data/topic_dict/exercise-dict.csv", header = FALSE)
```

```{r echo=FALSE, results='hide',message=FALSE}
##Compute general bag of words.
bag_of_words <- combined_data %>% unnest_tokens(word, text)
word_count <- bag_of_words %>% count(word, sort = TRUE)
```

##Introduction.
HappyDB is a corpus of 100,000 crowd-sourced happy moments. There are many interesting phenomena that can be revealed by the data in this database. Many people say that marriage is the grave of love. Does marriage have impact on people's feelings, especially on happy things? What do people do before and after marriage? Let's take a look.

##Overall of whole dataset.
```{r echo=FALSE, results='hide',message=FALSE}
wordcloud2(word_count[1:150,], color = "random-light", backgroundColor = "white")
bag_of_words %>% 
  pairwise_count(word, id) %>% 
  filter(n >= 400) %>%
  graph_from_data_frame() %>%
  ggraph(layout = "fr") +
  geom_edge_link(aes(edge_alpha = n, edge_width = n), edge_colour = "blue") +
  geom_node_point(size = 3) +
  geom_node_text(aes(label = name), repel = TRUE,
  point.padding = unit(0.2, "lines"))
p <- ggplot(data = word_count[1:10, ], aes(x = reorder(word, -n), y = n)) + 
  geom_bar(stat = "identity", fill = "steelblue") +
  ggtitle("Rank of Frequency of Words")
p
```

Let's first take a look at what this database looks like. After I split the entire corpus, I draw a bar plot. It can be seen from the figure that the words friends, day, time, family, watched, and home have the highest frequency. As you can see from netgraph, how often these words are connected to other words. For example, time and family have strong connections, so as video and game.

```{r echo=FALSE, results='hide',message=FALSE}
##Hnadle data.
single <- combined_data %>% filter(marital %in% "single")
single_male <- single %>% filter(gender %in% "m")
single_female <- single %>% filter(gender %in% "f")

married <- combined_data %>% filter(marital %in% "married")
married_male <- married %>% filter(gender %in% "m")
married_female <- married %>% filter(gender %in% "f")

married_doesnot_have_child <- married %>% filter(parenthood %in% "n")
married_doesnot_have_child_male <- married_doesnot_have_child %>% filter(gender %in% "m")
married_doesnot_have_child_female <- married_doesnot_have_child %>% filter(gender %in% "f")

married_has_child <- married %>% filter(parenthood %in% "y")
married_has_child_male <- married_has_child %>% filter(gender %in% "m")
married_has_child_female <- married_has_child %>% filter(gender %in% "f")


bag_of_words_single <- single %>% unnest_tokens(word, text)
word_count_single <- bag_of_words_single %>% count(word, sort = TRUE)

bag_of_words_married <- married %>% unnest_tokens(word, text)
word_count_married <- bag_of_words_married %>% count(word, sort = TRUE)

bag_of_words_married_doesnot_have_child <- 
  combined_data %>% 
  filter(marital %in% "married") %>%
  filter(parenthood %in% "n") %>%
  unnest_tokens(word, text)
word_count_married_has_child <- bag_of_words_married_doesnot_have_child %>% count(word, sort = TRUE)

bag_of_words_married_has_child <- 
  combined_data %>% 
  filter(marital %in% "married") %>%
  filter(parenthood %in% "y") %>%
  unnest_tokens(word, text)
word_count_married_has_child <- bag_of_words_married_has_child %>% count(word, sort = TRUE)
```

##Topic analysis
There are some very common problems, for example, will people change before and after marriage? What is the difference between a man and a woman in their marriage?

```{r echo=FALSE, results='hide',message=FALSE}
##Topic analysis
single_pred_category <- data.frame(table(as.factor(single$predicted_category)))
single_pred_category %>%
arrange(desc(Freq)) %>%
mutate(prop = percent(Freq / sum(Freq))) -> single_pred_category

bp1 <- ggplot(single_pred_category, 
            aes(x = "Category", y = Freq, fill = Var1)) + 
            geom_bar(width = 1, stat = "identity")
pie1 <- bp1 + coord_polar("y", start = 0) +
            guides(fill = guide_legend(title = "Group")) +
            ggtitle("Single")
pie1
single_pred_category

married_pred_category <- data.frame(table(as.factor(married$predicted_category)))
married_pred_category %>%
arrange(desc(Freq)) %>%
mutate(prop = percent(Freq / sum(Freq))) -> married_pred_category
bp2 <- ggplot(married_pred_category, 
            aes(x = "Category", y = Freq, fill = Var1)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group"))
pie2 <- bp2 + coord_polar("y", start= 0) + ggtitle("Married")
pie2
married_pred_category
```

(The first table is for single and the second is for married people.)
I used the demographic information in the database to extract the happy moment for single and married people. In the pie chart, it is obvious that the proportion of "affection", that is, love, has increased significantly. In contrast, "achievement" has been significantly reduced. At the same time, people have less happy moments of leisrue, and the happy moment of exercise is relatively less. This results are consistent with our common sense. Compared with singles, people don't have so much personal disposable time after getting married. They have to spend more time facing their family.

```{r echo=FALSE, results='hide',message=FALSE}
##Draw graphs
married_male_pred_category <- data.frame(table(as.factor(married_male$predicted_category)))
married_male_pred_category %>%
arrange(desc(Freq)) %>%
mutate(prop = percent(Freq / sum(Freq))) -> married_male_pred_category
bp3 <- ggplot(married_male_pred_category, 
            aes(x = "Category", y = Freq, fill = Var1)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group"))
pie3 <- bp3 + coord_polar("y", start = 0) + ggtitle("Married Male")
pie3
married_male_pred_category

married_female_pred_category <- data.frame(table(as.factor(married_female$predicted_category)))
married_female_pred_category %>%
arrange(desc(Freq)) %>%
mutate(prop = percent(Freq / sum(Freq))) -> married_female_pred_category
bp4 <- ggplot(married_female_pred_category, 
            aes(x = "Category", y = Freq, fill = Var1)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group"))
pie4 <- bp4 + coord_polar("y", start = 0) + ggtitle("Married Female")
pie4
married_female_pred_category
```

(The first table is for married male and the second is for married female.)
In this comparison of married men and women, we can see that men have more "achievement" happy moments than women. Women's "affection" happy moment is more than men. This is also in line with our ideas. Men are more engaged with careers or other things that make them feel more "achievement" than women. On the other hand, women are more emotional.

```{r echo=FALSE, results='hide',message=FALSE}
##Extract entertainment related sentences from married people.
match_index <- match(bag_of_words_married$word, entertainment_topic$V1)
bag_of_words_married_with_match_index <- cbind(bag_of_words_married, match_index)
bag_of_words_married_with_match_index <- na.omit(bag_of_words_married_with_match_index)

##Remove duplicate hmid rows.
bag_of_words_married_with_match_index <- 
  bag_of_words_married_with_match_index[!duplicated(bag_of_words_married_with_match_index$hmid), ]

##Extract exercise related sentences from married people.
match_index <- match(bag_of_words_married$word, exercise_topic$V1)
bag_of_words_married_with_match_index_exerc <- cbind(bag_of_words_married, match_index)
bag_of_words_married_with_match_index_exerc <- na.omit(bag_of_words_married_with_match_index_exerc)

##Remove duplicate hmid rows.
bag_of_words_married_with_match_index_exerc <- 
  bag_of_words_married_with_match_index_exerc[!duplicated(bag_of_words_married_with_match_index_exerc$hmid), ]
```

```{r echo=FALSE, results='hide',message=FALSE}
##Extract entertainment related sentences from single people.
match_index <- match(bag_of_words_single$word, entertainment_topic$V1)
bag_of_words_single_with_match_index <- cbind(bag_of_words_single, match_index)
bag_of_words_single_with_match_index <- na.omit(bag_of_words_single_with_match_index)

##Remove duplicate hmid rows.
bag_of_words_single_with_match_index <- 
  bag_of_words_single_with_match_index[!duplicated(bag_of_words_single_with_match_index$hmid), ]

##Extract exercise related sentences from single people.
match_index <- match(bag_of_words_single$word, exercise_topic$V1)
bag_of_words_single_with_match_index_exerc <- cbind(bag_of_words_single, match_index)
bag_of_words_single_with_match_index_exerc <- na.omit(bag_of_words_single_with_match_index_exerc)

##Remove duplicate hmid rows.
bag_of_words_single_with_match_index_exerc <- 
  bag_of_words_single_with_match_index_exerc[!duplicated(bag_of_words_single_with_match_index_exerc$hmid), ]
```

```{r echo=FALSE, results='hide',message=FALSE}
##Entertainment comparison for married and single people.
##Married
married_entertainment_count <- bag_of_words_married_with_match_index %>% count(word, sort = TRUE)
married_entertainment_count %>%
arrange(desc(n)) %>%
mutate(prop = percent(n / sum(n))) -> married_entertainment_count
bp5 <- ggplot(married_entertainment_count[1:5, ], 
            aes(x = "Category", y = n, fill = word)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group")) +
            ggtitle("Married")

##Single
single_entertainment_count <- bag_of_words_single_with_match_index %>% count(word, sort = TRUE)
single_entertainment_count %>%
arrange(desc(n)) %>%
mutate(prop = percent(n / sum(n))) -> single_entertainment_count
bp6 <- ggplot(single_entertainment_count[1:5, ], 
            aes(x = "Category", y = n, fill = word)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group")) +
            ggtitle("Single")

grid.arrange(bp5, bp6, nrow = 1)
married_entertainment_count[1:5, ]
single_entertainment_count[1:5, ]
```

Will the entertainment activities of people change before and after marriage? I took people's first five entertainment, activities according to the frequency of the two groups of activities, before and after marriage and compared them. It should be noted that the “video” here actually represents video games. We can very clearly find that after marriage, the happy moments of people playing video games are significantly reduced. (My girlfriend doesn't allow me to play games. Sad.) In contrast, the happy moment of watching movies has increased a lot. This phenomenon is very reasonable. The joy of plaaying computer or console game is belong to a single person. Because other than the participants, people watching are not so easy to get joy. However, the fun of watching movies with the family can be shared with family members.

```{r echo=FALSE, results='hide',message=FALSE}
##Exercises comparison for married and single people.
##Married
married_exerc_count <- bag_of_words_married_with_match_index_exerc %>% count(word, sort = TRUE)
married_exerc_count %>%
arrange(desc(n)) %>%
mutate(prop = percent(n / sum(n))) -> married_exerc_count
bp7 <- ggplot(married_exerc_count[1:5, ], 
            aes(x = "Category", y = n, fill = word)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group")) +
            ggtitle("Married")

##Single
single_exerc_count <- bag_of_words_single_with_match_index_exerc %>% count(word, sort = TRUE)
single_exerc_count %>%
arrange(desc(n)) %>%
mutate(prop = percent(n / sum(n))) -> single_exerc_count
bp8 <- ggplot(single_exerc_count[1:5, ], 
            aes(x = "Category", y = n, fill = word)) + 
            geom_bar(width = 1, stat = "identity") + 
            guides(fill = guide_legend(title = "Group")) +
            ggtitle("Single")

grid.arrange(bp7, bp8, nrow = 1)
```

Will people's exercise habits change after marriage? Interestingly, it will. I also selected the first five sports activities based on frequency. From the results, the happy moment after marriage has basketball and softball, which are not shown in single activites. A possible explanation is that these can be family activities. Same reason as the joy of watching a movie, the happiness of the collective activities can be shared.

```{r echo=FALSE, results='hide',message=FALSE}
##Sentiment analysis for single vs married when doing certain entertainment activities.
##(Movie, Video, Music, Book)
##Extract (Movie, Video, Music, Book) from bag_of_words.
topic_ent <- c("movie", "video", "music", "book")
sm_bow_married <- na.omit(cbind(bag_of_words_married_with_match_index,
              match(bag_of_words_married_with_match_index$word, topic_ent)))
##Topic index is the index in the vector topic_ent
colnames(sm_bow_married)[ncol(sm_bow_married)] <- "topic_index"

sm_bow_single <- na.omit(cbind(bag_of_words_single_with_match_index,
              match(bag_of_words_single_with_match_index$word, topic_ent)))
colnames(sm_bow_single)[ncol(sm_bow_single)] <- "topic_index"

##Retain the original married df with entertainment texts.
hmid_married_ent <- sm_bow_married$hmid
sm_analysis_married <- cbind(na.omit(
  cbind(married, match(married$hmid, hmid_married_ent))), sm_bow_married$topic_index)

##Retain the original single df with entertainment texts.
hmid_single_ent <- sm_bow_single$hmid
sm_analysis_single <- cbind(na.omit(
  cbind(single, match(single$hmid, hmid_single_ent))), sm_bow_single$topic_index)

##Emotion analysis
##Married
emotions_married_ent = get_nrc_sentiment(sm_analysis_married$text)
word.count_married_ent = word_count(sm_analysis_married$text)
# colnames(emotions)=paste0("emo.", colnames(emotions))
# in case the word counts are zeros?
emotions_weighted_married_ent = diag(1 / (word.count_married_ent + 0.01)) %*% as.matrix(emotions_married_ent)

##Single
emotions_single_ent = get_nrc_sentiment(sm_analysis_single$text)
word.count_single_ent = word_count(sm_analysis_single$text)
# colnames(emotions)=paste0("emo.", colnames(emotions))
# in case the word counts are zeros?
emotions_weighted_single_ent = diag(1 / (word.count_single_ent + 0.01)) %*% as.matrix(emotions_single_ent)

##Remove "negative" colnum.
emotions_weighted_married_ent <- emotions_weighted_married_ent[, -9]
emotions_weighted_single_ent <- emotions_weighted_single_ent[, -9]

sm_analysis_married <- cbind(sm_analysis_married, emotions_weighted_married_ent)
sm_analysis_single <- cbind(sm_analysis_single, emotions_weighted_single_ent)

married_emotions <- sm_analysis_married[,c(1, 19:27)] %>% gather("emotion", "prop", -hmid)
single_emotions <- sm_analysis_single[,c(1, 19:27)] %>% gather("emotion", "prop", -hmid)

married_emotions <- married_emotions %>% inner_join(sm_analysis_married, by = "hmid")
single_emotions <- single_emotions %>% inner_join(sm_analysis_single, by = "hmid")
```




















